<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Virtual Try-On for Cosmetics by Malind Tech">
    <meta name="keywords" content="virtual try-on, cosmetics, foundation, lipstick, blush">
    <title>Malind Tech | Professional Virtual Try-On</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.3;
            overflow-x: hidden;
            font-size: 12px;
        }
        
        .header {
            background: white;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        
        .logo {
            font-size: 16px;
            font-weight: 500;
            color: #000;
        }
        
        .logo span {
            font-weight: 300;
            font-size: 12px;
        }
        
        .nav { 
            display: none; 
            gap: 15px;
        }
        
        .nav a {
            color: #333;
            text-decoration: none;
            font-size: 13px;
            font-weight: 400;
        }
        
        .search-cart {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-cart a {
            color: #333;
            text-decoration: none;
            font-size: 11px;
            font-weight: 400;
        }
        
        .user-account {
            margin-left: 10px;
        }
        
        .user-account a {
            color: #e6007e;
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 10px;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .page-title h1 {
            font-size: 18px;
            font-weight: 300;
            margin-bottom: 5px;
        }
        
        .page-title p {
            color: #666;
            font-size: 12px;
        }
        
        .content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .try-on-section {
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .video-container {
            background: #f8f8f8;
            position: relative;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #videoFeed, #uploadedImage, #beforeImage {
            max-width: 100%;
            max-height: 250px;
            display: none;
            width: 100%;
            height: auto;
            transition: transform 0.3s ease;
        }
        
        .video-container.zoomed #videoFeed,
        .video-container.zoomed #uploadedImage,
        .video-container.zoomed #beforeImage {
            transform: scale(1.2);
        }
        
        .face-stats {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            z-index: 60;
        }
        
        .mode-selector {
            display: flex;
            gap: 2px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .mode-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            font-size: 11px;
            transition: background 0.3s;
        }
        
        .mode-btn.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .mode-btn:hover {
            background: #f0f0f0;
        }
        
        .comparison-toggle {
            padding: 10px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .comparison-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            font-size: 11px;
            transition: background 0.3s;
        }
        
        .comparison-btn.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .comparison-btn:hover {
            background: #f0f0f0;
        }
        
        .product-controls {
            background: white;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .product-title {
            font-size: 14px;
            font-weight: 500;
        }
        
        .product-rating {
            font-size: 12px;
            color: #e6007e;
        }
        
        .product-description {
            color: #666;
            margin-bottom: 10px;
            font-size: 11px;
        }
        
        .cosmetic-toggle {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
        }

        .cosmetic-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            background: white;
            color: #333;
            transition: background 0.3s;
        }

        .cosmetic-btn.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .cosmetic-btn:hover {
            background: #f0f0f0;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group h3 {
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .shades-grid, .lipstick-shades, .blush-shades {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .shade-option, .lipstick-option, .blush-option {
            width: 100%;
            border: 1px solid transparent;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            padding: 5px;
        }
        
        .shade-option:hover, .lipstick-option:hover, .blush-option:hover {
            transform: scale(1.05);
        }
        
        .shade-option.active, .lipstick-option.active, .blush-option.active {
            border-color: #000;
        }
        
        .shade-color, .lipstick-color, .blush-color {
            width: 40px;
            height: 40px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .shade-info, .lipstick-info, .blush-info {
            flex: 1;
            text-align: left;
            font-size: 10px;
        }
        
        .shade-name, .lipstick-name, .blush-name {
            font-weight: 500;
            color: #000;
            font-size: 9px;
        }
        
        .shade-undertone, .lipstick-type, .blush-type {
            font-size: 8px;
            color: #666;
        }
        
        .intensity-control {
            margin: 10px 0;
        }
        
        .slider {
            width: 100%;
            height: 2px;
            border-radius: 1px;
            background: #eee;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #000;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .intensity-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 3px;
            color: #666;
            font-size: 9px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-reset {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-reset:hover {
            background: #eee;
        }
        
        .btn-capture {
            background: #000;
            color: white;
        }
        
        .btn-capture:hover {
            background: #333;
        }
        
        .btn-share {
            background: #007bff;
            color: white;
        }
        
        .btn-share:hover {
            background: #0069d9;
        }
        
        .btn-add-to-cart {
            background: #e6007e;
            color: white;
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .btn-add-to-cart:hover {
            background: #c4006a;
        }
        
        .current-shade {
            background: #f9f9f9;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .current-shade h4 {
            color: #000;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 12px;
        }
        
        .current-shade .shade-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 auto 5px;
            border: 1px solid #000;
        }
        
        .loading {
            color: #666;
            text-align: center;
            padding: 15px;
            font-style: italic;
            font-size: 12px;
        }
        
        .welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .welcome-content {
            background: white;
            padding: 15px;
            border-radius: 6px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .welcome-content h2 {
            color: #000;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 300;
        }
        
        .welcome-content p {
            color: #666;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mode-option {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }
        
        .mode-option:hover {
            background: #f0f0f0;
        }
        
        .mode-option.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .mode-icon {
            font-size: 1.8em;
        }
        
        .mode-option h3 {
            font-size: 14px;
            font-weight: 400;
            margin: 0;
        }
        
        .mode-option p {
            font-size: 11px;
            opacity: 0.8;
            margin: 0;
            line-height: 1.2;
        }
        
        .start-btn {
            background: #000;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 5px;
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .start-btn:hover {
            background: #333;
        }
        
        #fileName {
            margin: 5px 0;
            color: #666;
            font-size: 11px;
        }
        
        .footer {
            background: white;
            padding: 10px;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 11px;
            color: #666;
            margin-top: 20px;
        }
        
        .footer a {
            color: #e6007e;
            text-decoration: none;
            margin: 0 5px;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .recommend-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: background 0.3s;
        }
        
        .recommend-btn:hover {
            background: #218838;
        }
        
        @media (min-width: 769px) {
            .content {
                flex-direction: row;
                gap: 20px;
            }
            
            .nav { display: flex; }
            .nav a { font-size: 13px; }
            
            .video-container { min-height: 450px; }
            #videoFeed, #uploadedImage, #beforeImage { max-height: 450px; }
            
            .product-controls { padding: 20px; }
            .shades-grid, .lipstick-shades, .blush-shades { gap: 15px; }
        }
        
        @media (max-width: 480px) {
            .cosmetic-toggle {
                flex-direction: column;
            }
            
            .cosmetic-btn {
                padding: 8px;
            }
            .shades-grid, .lipstick-shades, .blush-shades {
                grid-template-columns: repeat(2, 1fr); /* Adjust for smaller screens */
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">MALIND <span>TECH</span></div>
            <nav class="nav">
                <a href="#">Products</a>
                <a href="#">Categories</a>
                <a href="#">Limited Edition</a>
                <a href="#">Baseline</a>
            </nav>
            <div class="search-cart">
                <a href="#">Search</a>
                <a href="#">Cart</a>
            </div>
            <div class="user-account">
                <a href="#">Login / Register</a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="page-title">
            <h1>Professional Virtual Try-On</h1>
            <p>Use your camera or upload a photo for a realistic cosmetic experience in natural light</p>
        </div>
        
        <div class="content">
            <div class="try-on-section">
                <div class="video-container" id="videoContainer">
                    <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Video Feed">
                    <img id="uploadedImage" alt="Uploaded Image">
                    <img id="beforeImage" alt="Before Image">
                    <div class="face-stats" id="faceStats" style="display: none;">
                        <div>F: <span id="faceCount">0</span></div>
                        <div>C: <span id="confidence">0%</span></div>
                    </div>
                    <div class="loading" id="loadingMessage">Loading camera...</div>
                </div>
                
                <div class="mode-selector">
                    <button class="mode-btn active" id="liveModeBtn" onclick="startSelfieMode()">Live Video</button>
                    <button class="mode-btn" id="uploadModeBtn" onclick="showUploadSection()">Upload Photo</button>
                </div>
                <div class="comparison-toggle">
                    <button class="comparison-btn" id="beforeAfterBtn" onclick="toggleComparison()">Before/After</button>
                </div>
            </div>
            
            <div class="product-controls">
                <div class="product-header">
                    <div class="product-title">Foundation</div>
                    <div class="product-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4.8/5)</div>
                </div>
                
                <div class="product-description">Our advanced foundation with light-reflecting technology for a flawless, professional finish. Dermatologist-tested and suitable for all skin types.</div>
                
                <div class="current-shade">
                    <h4>Current Shade</h4>
                    <div class="shade-preview" id="currentShadePreview"></div>
                    <div id="currentShadeName">WARM IVORY</div>
                </div>

                <div class="cosmetic-toggle">
                    <button class="cosmetic-btn active" id="foundationBtn" onclick="showFoundation()">Foundation</button>
                    <button class="cosmetic-btn" id="lipstickBtn" onclick="showLipstick()">Lipstick</button>
                    <button class="cosmetic-btn" id="blushBtn" onclick="showBlush()">Blush</button>
                </div>
                
                <div class="control-group" id="foundationControls">
                    <h3>Foundation Shades</h3>
                    <div class="shades-grid" id="shadesGrid"></div>
                    <h3>Intensity Level</h3>
                    <div class="intensity-control">
                        <input type="range" min="0" max="100" value="70" class="slider" id="intensitySlider">
                        <div class="intensity-labels">
                            <span>Light Coverage</span>
                            <span>Medium</span>
                            <span>Full Coverage</span>
                        </div>
                    </div>
                </div>

                <div class="control-group" id="lipstickControls" style="display: none;">
                    <h3>Lipstick Shades</h3>
                    <div class="lipstick-shades" id="lipstickGrid"></div>
                    <h3>Intensity Level</h3>
                    <div class="intensity-control">
                        <input type="range" min="0" max="100" value="80" class="slider" id="lipstickIntensitySlider">
                        <div class="intensity-labels">
                            <span>Sheer</span>
                            <span>Medium</span>
                            <span>Bold</span>
                        </div>
                    </div>
                </div>

                <div class="control-group" id="blushControls" style="display: none;">
                    <h3>Blush Shades</h3>
                    <div class="blush-shades" id="blushGrid"></div>
                    <h3>Intensity Level</h3>
                    <div class="intensity-control">
                        <input type="range" min="0" max="100" value="60" class="slider" id="blushIntensitySlider">
                        <div class="intensity-labels">
                            <span>Subtle Glow</span>
                            <span>Natural</span>
                            <span>Dramatic</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-reset" onclick="resetFoundation()">Reset</button>
                    <button class="btn btn-capture" onclick="captureImage()">Capture Try-On</button>
                    <button class="btn btn-share" onclick="shareTryOn()">Share</button>
                </div>
                
                <button class="btn btn-add-to-cart">Add to Cart</button>
                <button class="recommend-btn" onclick="recommendShade()">AI Shade Recommendation</button>
            </div>
        </div>
    </div>

    <div class="welcome-popup" id="welcomePopup">
        <div class="welcome-content">
            <h2>Professional Virtual Try-On</h2>
            <p>Select your preferred mode for a seamless experience</p>
            
            <div class="mode-options">
                <div class="mode-option" onclick="selectMode('selfi')">
                    <div class="mode-icon">üé•</div>
                    <h3>Live Camera</h3>
                    <p>Real-time try-on with advanced face detection</p>
                </div>
                
                <div class="mode-option" onclick="selectMode('upload')">
                    <div class="mode-icon">üì∑</div>
                    <h3>Upload Photo</h3>
                    <p>Apply cosmetics to your uploaded image</p>
                </div>
            </div>
            
            <button class="start-btn" id="startLiveBtn" onclick="startSelfieMode()" style="display: none;">
                üé• Start Live Mode
            </button>
            
            <div class="upload-section" id="uploadSection" style="display: none;">
                <input type="file" id="imageUpload" accept="image/*">
                <label for="imageUpload" class="start-btn">üìÅ Upload Image</label>
                <div id="fileName"></div>
                <button class="start-btn" id="startUploadBtn" onclick="startWithUpload()" disabled>
                    üöÄ Apply Try-On
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Malind Tech. All rights reserved.</p>
        <a href="#">Terms of Service</a> | <a href="#">Privacy Policy</a> | <a href="#">Contact Us</a>
    </footer>

    <script>
    let currentShade = '03', currentLipstick = 'L01', currentBlush = 'B01', currentMode = null, uploadedImage = null, beforeImage = null, faceDetectionActive = false, faceDetectionInterval = null, isComparisonActive = false;

    function selectMode(mode) {
        document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(mode === 'upload' ? 'uploadSection' : 'startLiveBtn').style.display = 'block';
        document.getElementById(mode === 'upload' ? 'startLiveBtn' : 'uploadSection').style.display = 'none';
    }

    document.getElementById('imageUpload').addEventListener('change', e => {
        const file = e.target.files[0], btn = document.getElementById('startUploadBtn'), name = document.getElementById('fileName');
        if (file) {
            name.textContent = `Selected: ${file.name}`;
            btn.disabled = false;
            const reader = new FileReader();
            reader.onload = ev => {
                uploadedImage = ev.target.result;
                beforeImage = ev.target.result; // Set before image
            };
            reader.readAsDataURL(file);
        } else {
            name.textContent = '';
            btn.disabled = true;
        }
    });

    function startWithUpload() {
        if (!uploadedImage) return alert('Please select an image!');
        currentMode = 'upload';
        startApp();
    }

    function startSelfieMode() {
        currentMode = 'selfi';
        startApp();
    }

    function startApp() {
        document.getElementById('welcomePopup').style.display = 'none';
        if (currentMode === 'upload') {
            // Apply foundation to uploaded image
            applyFoundationToUploadedImage(uploadedImage);
            document.getElementById('uploadModeBtn').classList.add('active');
            document.getElementById('liveModeBtn').classList.remove('active');
            stopFaceDetection();
        } else {
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('beforeImage').style.display = 'none';
            document.getElementById('videoFeed').style.display = 'block';
            document.getElementById('faceStats').style.display = 'block';
            document.getElementById('liveModeBtn').classList.add('active');
            document.getElementById('uploadModeBtn').classList.remove('active');
            startFaceDetection();
        }
        loadShades(); loadLipsticks(); loadBlushes();
    }

    // NEW FUNCTION: Apply foundation to uploaded image
    async function applyFoundationToUploadedImage(imageData) {
        try {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('beforeImage').style.display = 'none';
            
            const response = await fetch('/api/process_base64', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image: imageData,
                    shade: currentShade,
                    intensity: document.getElementById('intensitySlider').value / 100
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('uploadedImage').src = data.processed_image;
                document.getElementById('uploadedImage').style.display = 'block';
                document.getElementById('beforeImage').src = imageData;
                document.getElementById('loadingMessage').style.display = 'none';
                console.log('‚úÖ Foundation applied successfully to uploaded image');
            } else {
                throw new Error(data.message || 'Failed to apply foundation');
            }
        } catch (error) {
            console.error('‚ùå Error applying foundation:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('uploadedImage').src = imageData;
            document.getElementById('uploadedImage').style.display = 'block';
            alert('Error: ' + error.message + '\n\nPlease try a different image with a clear frontal face.');
        }
    }

    // UPDATED: When shade changes, re-apply foundation to uploaded image
    async function selectShade(id) {
        try {
            const res = await fetch('/api/set_shade', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({shade:id})
            });
            
            if ((await res.json()).status === 'success') {
                currentShade = id;
                updateCurrentShade(id);
                updateActiveShade(id);
                
                // If in upload mode, re-apply foundation with new shade
                if (currentMode === 'upload' && uploadedImage) {
                    applyFoundationToUploadedImage(uploadedImage);
                }
            }
        } catch (error) {
            console.error('Error setting shade:', error);
            currentShade = id;
            updateCurrentShade(id);
            updateActiveShade(id);
        }
    }

    // UPDATED: When intensity changes, re-apply foundation to uploaded image
    document.getElementById('intensitySlider').addEventListener('input', function() {
        if (currentMode === 'upload' && uploadedImage) {
            // Add a small delay to avoid too many API calls
            clearTimeout(this.debounce);
            this.debounce = setTimeout(() => {
                applyFoundationToUploadedImage(uploadedImage);
            }, 500);
        }
    });

    function startFaceDetection() {
        faceDetectionActive = true;
        faceDetectionInterval = setInterval(() => {
            if (faceDetectionActive && currentMode === 'selfi') simulateFaceDetection();
        }, 100);
    }

    function stopFaceDetection() {
        faceDetectionActive = false;
        if (faceDetectionInterval) clearInterval(faceDetectionInterval);
    }

    function simulateFaceDetection() {
        const faceCount = Math.random() > 0.3 ? 1 : 0;
        document.getElementById('faceCount').textContent = faceCount;
        document.getElementById('confidence').textContent = (faceCount > 0 ? (Math.floor(Math.random() * 30) + 70) : 0) + '%';
    }

    function showFoundation() {
        document.getElementById('foundationControls').style.display = 'block';
        document.getElementById('lipstickControls').style.display = 'none';
        document.getElementById('blushControls').style.display = 'none';
        document.getElementById('foundationBtn').classList.add('active');
        document.getElementById('lipstickBtn').classList.remove('active');
        document.getElementById('blushBtn').classList.remove('active');
    }

    function showLipstick() {
        document.getElementById('foundationControls').style.display = 'none';
        document.getElementById('lipstickControls').style.display = 'block';
        document.getElementById('blushControls').style.display = 'none';
        document.getElementById('foundationBtn').classList.remove('active');
        document.getElementById('lipstickBtn').classList.add('active');
        document.getElementById('blushBtn').classList.remove('active');
    }

    function showBlush() {
        document.getElementById('foundationControls').style.display = 'none';
        document.getElementById('lipstickControls').style.display = 'none';
        document.getElementById('blushControls').style.display = 'block';
        document.getElementById('foundationBtn').classList.remove('active');
        document.getElementById('lipstickBtn').classList.remove('active');
        document.getElementById('blushBtn').classList.add('active');
    }

    async function loadShades() {
        try {
            const res = await fetch('/api/shades'), data = await res.json();
            displayShades(data.shades);
            updateCurrentShade(data.current);
        } catch {
            const shades = {
                '01': { name: 'PORCELAIN', hex: '#F5E9DE', undertone: 'Cool' },
                '02': { name: 'IVORY', hex: '#F0E2D1', undertone: 'Neutral' },
                '03': { name: 'WARM IVORY', hex: '#E0C7B0', undertone: 'Warm' },
                '04': { name: 'SAND', hex: '#D5B390', undertone: 'Neutral' },
                '05': { name: 'BEIGE', hex: '#C8A181', undertone: 'Warm' },
                '06': { name: 'CARAMEL', hex: '#AF8A65', undertone: 'Warm' },
                '07': { name: 'WALNUT', hex: '#976E4B', undertone: 'Cool' },
                '08': { name: 'COFFEE', hex: '#7A573F', undertone: 'Neutral' },
                '09': { name: 'DEEP COCOA', hex: '#5D4037', undertone: 'Warm' },
                '10': { name: 'ALMOND', hex: '#D2B48C', undertone: 'Neutral' },
                '11': { name: 'HONEY', hex: '#CDA776', undertone: 'Warm' },
                '12': { name: 'CHESTNUT', hex: '#8B4513', undertone: 'Warm' }
            };
            displayShades(shades);
            updateCurrentShade('03');
        }
    }

    function displayShades(shades) {
        const grid = document.getElementById('shadesGrid');
        grid.innerHTML = Object.entries(shades).map(([id, info]) => 
            `<div class="shade-option ${id===currentShade?'active':''}" onclick="selectShade('${id}')">
                <div class="shade-color" style="background-color:${info.hex}"></div>
                <div class="shade-info">
                    <div class="shade-name">${info.name}</div>
                    <div class="shade-undertone">${info.undertone}</div>
                </div>
            </div>`).join('');
    }

    function updateCurrentShade(id) {
        const info = getShadeInfo(id);
        if (info) {
            document.getElementById('currentShadeName').textContent = info.name;
            document.getElementById('currentShadePreview').style.backgroundColor = info.hex;
        }
    }

    function getShadeInfo(id) {
        const shades = {
            '01': { name: 'PORCELAIN', hex: '#F5E9DE' },
            '02': { name: 'IVORY', hex: '#F0E2D1' },
            '03': { name: 'WARM IVORY', hex: '#E0C7B0' },
            '04': { name: 'SAND', hex: '#D5B390' },
            '05': { name: 'BEIGE', hex: '#C8A181' },
            '06': { name: 'CARAMEL', hex: '#AF8A65' },
            '07': { name: 'WALNUT', hex: '#976E4B' },
            '08': { name: 'COFFEE', hex: '#7A573F' },
            '09': { name: 'DEEP COCOA', hex: '#5D4037' },
            '10': { name: 'ALMOND', hex: '#D2B48C' },
            '11': { name: 'HONEY', hex: '#CDA776' },
            '12': { name: 'CHESTNUT', hex: '#8B4513' }
        };
        return shades[id];
    }

    function updateActiveShade(id) {
        document.querySelectorAll('.shade-option').forEach(opt => opt.classList.remove('active'));
        const active = document.querySelector(`.shade-option[onclick="selectShade('${id}')"]`);
        if (active) active.classList.add('active');
    }

    async function loadLipsticks() {
        try {
            const res = await fetch('/api/lipsticks'), data = await res.json();
            displayLipsticks(data.lipsticks);
        } catch {
            const lipsticks = {
                'L01': { name: 'NUDE PINK', hex: '#E8B4A9', type: 'Matte' },
                'L02': { name: 'CLASSIC RED', hex: '#C41E3A', type: 'Cream' },
                'L03': { name: 'BERRY WINE', hex: '#722F37', type: 'Matte' },
                'L04': { name: 'CORAL GLOW', hex: '#FF7F50', type: 'Glossy' },
                'L05': { name: 'MAUVE MAGIC', hex: '#915F6D', type: 'Satin' },
                'L06': { name: 'PEACH NUDE', hex: '#FAD5A5', type: 'Cream' },
                'L07': { name: 'DEEP BURGUNDY', hex: '#800020', type: 'Matte' },
                'L08': { name: 'ROSE QUARTZ', hex: '#F7CAC9', type: 'Glossy' },
                'L09': { name: 'TERRACOTTA', hex: '#E2725B', type: 'Satin' },
                'L10': { name: 'PLUM DELIGHT', hex: '#9932CC', type: 'Matte' },
                'L11': { name: 'RUBY RED', hex: '#9B111E', type: 'Cream' },
                'L12': { name: 'NUDE BEIGE', hex: '#D2B48C', type: 'Satin' }
            };
            displayLipsticks(lipsticks);
        }
    }

    function displayLipsticks(lipsticks) {
        const grid = document.getElementById('lipstickGrid');
        grid.innerHTML = Object.entries(lipsticks).map(([id, info]) => 
            `<div class="lipstick-option ${id===currentLipstick?'active':''}" onclick="selectLipstick('${id}')">
                <div class="lipstick-color" style="background-color:${info.hex}"></div>
                <div class="lipstick-info">
                    <div class="lipstick-name">${info.name}</div>
                    <div class="lipstick-type">${info.type}</div>
                </div>
            </div>`).join('');
    }

    async function selectLipstick(id) {
        currentLipstick = id;
        updateActiveLipstick(id);
    }

    function updateActiveLipstick(id) {
        document.querySelectorAll('.lipstick-option').forEach(opt => opt.classList.remove('active'));
        const active = document.querySelector(`.lipstick-option[onclick="selectLipstick('${id}')"]`);
        if (active) active.classList.add('active');
    }

    async function loadBlushes() {
        try {
            const res = await fetch('/api/blushes'), data = await res.json();
            displayBlushes(data.blushes);
        } catch {
            const blushes = {
                'B01': { name: 'SOFT PINK', hex: '#F8C3CD', type: 'Powder' },
                'B02': { name: 'PEACH GLOW', hex: '#FFCBA4', type: 'Cream' },
                'B03': { name: 'ROSE DUST', hex: '#B76E79', type: 'Powder' },
                'B04': { name: 'CORAL SUNSET', hex: '#FF7F50', type: 'Liquid' },
                'B05': { name: 'MAUVE MIST', hex: '#C8A2C8', type: 'Powder' },
                'B06': { name: 'APRICOT NECTAR', hex: '#FBCEb1', type: 'Cream' },
                'B07': { name: 'DEEP BERRY', hex: '#954535', type: 'Powder' },
                'B08': { name: 'TERRACOTTA', hex: '#E2725B', type: 'Liquid' },
                'B09': { name: 'PLUM WINE', hex: '#673147', type: 'Cream' },
                'B10': { name: 'GOLDEN ROSE', hex: '#DAA520', type: 'Powder' },
                'B11': { name: 'BERRY BLUSH', hex: '#C71585', type: 'Cream' },
                'B12': { name: 'NATURAL PEACH', hex: '#FFDAB9', type: 'Liquid' }
            };
            displayBlushes(blushes);
        }
    }

    function displayBlushes(blushes) {
        const grid = document.getElementById('blushGrid');
        grid.innerHTML = Object.entries(blushes).map(([id, info]) => 
            `<div class="blush-option ${id===currentBlush?'active':''}" onclick="selectBlush('${id}')">
                <div class="blush-color" style="background-color:${info.hex}"></div>
                <div class="blush-info">
                    <div class="blush-name">${info.name}</div>
                    <div class="blush-type">${info.type}</div>
                </div>
            </div>`).join('');
    }

    async function selectBlush(id) {
        currentBlush = id;
        updateActiveBlush(id);
    }

    function updateActiveBlush(id) {
        document.querySelectorAll('.blush-option').forEach(opt => opt.classList.remove('active'));
        const active = document.querySelector(`.blush-option[onclick="selectBlush('${id}')"]`);
        if (active) active.classList.add('active');
    }

    function resetFoundation() {
        currentShade = '03'; currentLipstick = 'L01'; currentBlush = 'B01';
        updateCurrentShade(currentShade);
        updateActiveShade(currentShade);
        updateActiveLipstick(currentLipstick);
        updateActiveBlush(currentBlush);
        document.getElementById('intensitySlider').value = 70;
        document.getElementById('lipstickIntensitySlider').value = 80;
        document.getElementById('blushIntensitySlider').value = 60;
        
        // If in upload mode, re-apply foundation with reset values
        if (currentMode === 'upload' && uploadedImage) {
            applyFoundationToUploadedImage(uploadedImage);
        }
    }

    function captureImage() {
        if (currentMode === 'upload' && isComparisonActive) {
            alert('Before and After images captured! In a full implementation, this would save or download both images.');
        } else {
            alert('Try-on image captured! In a full implementation, this would save or download the image.');
        }
    }

    function shareTryOn() {
        alert('Sharing your try-on look! In a full implementation, this would integrate with social media or email.');
    }

    function recommendShade() {
        alert('AI analyzing your skin tone... Recommended shade: WARM IVORY. In a full implementation, this would use AI for accurate recommendations.');
    }

    function toggleComparison() {
        const btn = document.getElementById('beforeAfterBtn');
        isComparisonActive = !isComparisonActive;
        btn.classList.toggle('active', isComparisonActive);

        if (currentMode === 'upload') {
            if (isComparisonActive) {
                document.getElementById('beforeImage').style.display = 'block';
                document.getElementById('uploadedImage').style.display = 'block';
                document.getElementById('videoFeed').style.display = 'none';
            } else {
                document.getElementById('beforeImage').style.display = 'none';
                document.getElementById('uploadedImage').style.display = 'block';
                document.getElementById('videoFeed').style.display = 'none';
            }
        } else {
            alert('Comparison is only available in Upload mode. Please upload an image to use this feature.');
        }
    }

    function showUploadSection() {
        document.getElementById('welcomePopup').style.display = 'flex';
        selectMode('upload');
    }

    window.addEventListener('beforeunload', stopFaceDetection);
</script>
</body>
</html>